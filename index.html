<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Combined Practice – States + Capitals (WA, OR, ID, CA, NV, UT, AZ, AK, HI)</title>
  <style>
    :root{
      --good:#16a34a;
      --bad:#dc2626;
      --ink:#111827;
      --muted:#6b7280;
    }
    body{margin:0;font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;color:var(--ink);}
    header{padding:16px 20px;border-bottom:1px solid #e5e7eb}
    header h1{margin:0;font-size:20px;font-weight:700}
    header .sub{font-size:13px;color:var(--muted)}

    .wrap{display:grid;grid-template-columns:1.2fr 1fr;gap:20px;padding:20px}
    @media(max-width:900px){.wrap{grid-template-columns:1fr}}

    .card{border:1px solid #e5e7eb;border-radius:16px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .toolbar{padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;flex-wrap:wrap;gap:8px}
    button{border:1px solid #e5e7eb;border-radius:10px;background:#fff;padding:8px 10px;font-weight:600;cursor:pointer;font-size:13px}
    button:hover{border-color:#cbd5e1}

    .map-shell{padding:12px}
    svg{width:100%;height:auto;display:block}
    .state{fill:#f5f5f5;stroke:#111827;stroke-width:0.8}
    .state.correct{fill:#d1fae5}
    .state.incorrect{fill:#fee2e2}

    .number{text-anchor:middle;font-size:11px;fill:#111827;stroke:#fff;stroke-width:3px;paint-order:stroke}
    .abbr{font-size:12px;font-weight:700;text-anchor:middle;fill:#111827}
    .cap-dot{fill:#111827;stroke:#fff;stroke-width:2}
    .cap-label{font-size:11px;fill:#111827;paint-order:stroke;stroke-width:3px;stroke:#fff}

    .panel h2{margin:12px 12px 4px;font-size:16px}
    .panel p{margin:0 12px 12px;color:var(--muted);font-size:13px}

    .list{padding:8px 12px 16px;display:grid;gap:10px}
    .row{display:grid;grid-template-columns:34px 1fr 1fr 18px;gap:8px;align-items:center}
    .row .num{border:1px solid #e5e7eb;border-radius:8px;padding:6px 0;font-weight:700;text-align:center;font-size:13px}
    .row input{padding:9px 10px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px;min-width:0}
    .row input:focus{outline:2px solid #bfdbfe;border-color:#bfdbfe}

    .tick{width:16px;height:16px;border:1px solid #e5e7eb;border-radius:50%}
    .tick.ok{background:var(--good);border-color:var(--good)}
    .tick.no{background:var(--bad);border-color:var(--bad)}

    .hdr{display:grid;grid-template-columns:34px 1fr 1fr 18px;gap:8px;align-items:end;padding:0 12px 8px;color:var(--muted);font-size:12px}
    .hdr div:nth-child(2), .hdr div:nth-child(3){padding-left:4px}

    @media print{
      header,.toolbar{display:none!important}
      .wrap{display:block;padding:0}
      .card{border:none;box-shadow:none}
      .panel{border-top:1px solid #e5e7eb;border-radius:0}
      .state{fill:#fff}
      .number,.abbr,.cap-dot,.cap-label{display:none}
      .tick{display:none}
      .row{grid-template-columns:34px 1fr 1fr}
      .hdr{grid-template-columns:34px 1fr 1fr}
    }
  </style>
</head>
<body>
<header>
  <h1>Combined Practice: States + Capitals</h1>
  <div class="sub">WA · OR · ID · CA · NV · UT · AZ · AK · HI — Use the same number for both the state name and its capital.</div>
</header>

<div class="wrap">
  <section class="card">
    <div class="toolbar">
      <button id="toggleNumbers">Hide numbers</button>
      <button id="shuffle">Shuffle numbers</button>
      <button id="toggleAbbr">Show state abbreviations</button>
      <button id="revealStates">Reveal states</button>
      <button id="revealCaps">Reveal capitals</button>
      <button onclick="window.print()">Print</button>
      <button id="reset">Reset</button>
    </div>
    <div class="map-shell">
      <svg id="map" viewBox="0 0 975 610" aria-label="Practice map of selected U.S. states"></svg>
    </div>
  </section>

  <aside class="card panel">
    <h2>Fill in BOTH columns</h2>
    <p>Type the <strong>state</strong> (left) and its <strong>capital</strong> (right) for each number. You can reveal states and capitals separately.</p>
    <div class="hdr"><div></div><div>State</div><div>Capital</div><div></div></div>
    <div class="list" id="answerList"></div>
  </aside>
</div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<script>
(function(){
  const STATES = [
    {abbr:'WA', name:'Washington', fips:'53', capital:'Olympia'},
    {abbr:'OR', name:'Oregon',     fips:'41', capital:'Salem'},
    {abbr:'ID', name:'Idaho',      fips:'16', capital:'Boise'},
    {abbr:'CA', name:'California', fips:'06', capital:'Sacramento'},
    {abbr:'NV', name:'Nevada',     fips:'32', capital:'Carson City'},
    {abbr:'UT', name:'Utah',       fips:'49', capital:'Salt Lake City'},
    {abbr:'AZ', name:'Arizona',    fips:'04', capital:'Phoenix'},
    {abbr:'AK', name:'Alaska',     fips:'02', capital:'Juneau'},
    {abbr:'HI', name:'Hawaii',     fips:'15', capital:'Honolulu'}
  ];

  const byFips = new Map(STATES.map(s => [s.fips, s]));
  let order = [...STATES];

  const svg  = d3.select('#map');
  const gStates  = svg.append('g').attr('class','states');
  const gNumbers = svg.append('g').attr('class','numbers');
  const gAbbrs   = svg.append('g').attr('class','abbrs');
  const gCaps    = svg.append('g').attr('class','caps');

  const projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
  const path = d3.geoPath(projection);

  const listEl  = document.getElementById('answerList');
  const btnShuffle       = document.getElementById('shuffle');
  const btnReset         = document.getElementById('reset');
  const btnToggleNumbers = document.getElementById('toggleNumbers');
  const btnToggleAbbr    = document.getElementById('toggleAbbr');
  const btnRevealStates  = document.getElementById('revealStates');
  const btnRevealCaps    = document.getElementById('revealCaps');

  let showNumbers = true;
  let showAbbr    = false;
  let statesRevealed = false;
  let capsRevealed = false;

  function normalize(str){
    return (str || '').toLowerCase().replace(/[^a-z]/g,'');
  }

  function buildList(){
    listEl.innerHTML = '';
    order.forEach((s,i) => {
      const row = document.createElement('div');
      row.className = 'row';
      row.dataset.abbr = s.abbr;
      row.innerHTML = `
        <div class="num">${i+1}</div>
        <input class="stateInput" aria-label="State for number ${i+1}" placeholder="State" />
        <input class="capInput" aria-label="Capital for number ${i+1}" placeholder="Capital" />
        <div class="tick"></div>`;
      listEl.appendChild(row);
    });
  }

  function drawNumbers(features){
    gNumbers.selectAll('*').remove();
    const map = new Map(order.map((s,i) => [s.fips, i+1]));
    features.forEach(f => {
      const n = map.get(f.id);
      if(!n) return;
      const c = path.centroid(f);
      if(!isFinite(c[0]) || !isFinite(c[1])) return;
      gNumbers.append('text')
        .attr('class','number')
        .attr('x', c[0])
        .attr('y', c[1])
        .text(n);
    });
    gNumbers.attr('display', showNumbers ? null : 'none');
  }

  function drawAbbrs(features){
    gAbbrs.selectAll('*').remove();
    features.forEach(f => {
      const s = byFips.get(f.id);
      if(!s) return;
      const c = path.centroid(f);
      if(!isFinite(c[0]) || !isFinite(c[1])) return;
      gAbbrs.append('text')
        .attr('class','abbr')
        .attr('x', c[0])
        .attr('y', c[1])
        .text(s.abbr);
    });
    gAbbrs.attr('display', showAbbr ? null : 'none');
  }

  function drawCaps(features){
    gCaps.selectAll('*').remove();
    features.forEach(f => {
      const s = byFips.get(f.id);
      if(!s) return;
      const c = path.centroid(f);
      if(!isFinite(c[0]) || !isFinite(c[1])) return;

      gCaps.append('circle')
        .attr('class','cap-dot')
        .attr('cx', c[0])
        .attr('cy', c[1])
        .attr('r', 4);

      gCaps.append('text')
        .attr('class','cap-label')
        .attr('x', c[0] + 8)
        .attr('y', c[1] - 6)
        .text(s.capital);
    });
    gCaps.attr('display','none');
  }

  function checkAnswers(){
    const rows = listEl.querySelectorAll('.row');
    rows.forEach(row => {
      const abbr = row.dataset.abbr;
      const meta = STATES.find(s => s.abbr === abbr);

      const stateVal = row.querySelector('.stateInput').value;
      const capVal   = row.querySelector('.capInput').value;

      const stateOk = stateVal ? (normalize(stateVal) === normalize(meta.name)) : false;
      const capOk   = capVal ? (normalize(capVal) === normalize(meta.capital)) : false;

      // tick logic: show ok if any filled and all filled fields are correct
      const anyFilled = !!(stateVal || capVal);
      const allFilledCorrect = (!stateVal || stateOk) && (!capVal || capOk);

      const tick = row.querySelector('.tick');
      tick.className = 'tick ' + (anyFilled ? (allFilledCorrect ? 'ok' : 'no') : '');

      // map color: reflect combined correctness for any filled fields
      const sel = svg.select('#state-' + meta.fips);
      sel.classed('correct', anyFilled && allFilledCorrect)
         .classed('incorrect', anyFilled && !allFilledCorrect);
    });
  }

  function resetAll(){
    listEl.querySelectorAll('input').forEach(i => i.value = '');
    listEl.querySelectorAll('.tick').forEach(t => t.className = 'tick');
    svg.selectAll('.state').classed('correct',false).classed('incorrect',false);

    statesRevealed = false;
    capsRevealed = false;
    gAbbrs.attr('display', showAbbr ? null : 'none');
    gCaps.attr('display','none');
    btnRevealStates.textContent = 'Reveal states';
    btnRevealCaps.textContent = 'Reveal capitals';
  }

  function revealStates(){
    statesRevealed = !statesRevealed;
    // overlay abbreviations even if toggle is off
    gAbbrs.attr('display', (showAbbr || statesRevealed) ? null : 'none');
    btnRevealStates.textContent = statesRevealed ? 'Hide states' : 'Reveal states';

    if(statesRevealed){
      listEl.querySelectorAll('.row').forEach(row => {
        const abbr = row.dataset.abbr;
        const meta = STATES.find(s => s.abbr === abbr);
        row.querySelector('.stateInput').value = meta.name;
      });
      checkAnswers();
    }
  }

  function revealCaps(){
    capsRevealed = !capsRevealed;
    gCaps.attr('display', capsRevealed ? null : 'none');
    btnRevealCaps.textContent = capsRevealed ? 'Hide capitals' : 'Reveal capitals';

    if(capsRevealed){
      listEl.querySelectorAll('.row').forEach(row => {
        const abbr = row.dataset.abbr;
        const meta = STATES.find(s => s.abbr === abbr);
        row.querySelector('.capInput').value = meta.capital;
      });
      checkAnswers();
    }
  }

  function shuffle(arr){
    for(let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function shuffleNumbers(features){
    shuffle(order);
    buildList();
    drawNumbers(features);
    attachListListeners();
    resetAll();
  }

  function toggleNumbers(){
    showNumbers = !showNumbers;
    gNumbers.attr('display', showNumbers ? null : 'none');
    btnToggleNumbers.textContent = showNumbers ? 'Hide numbers' : 'Show numbers';
  }

  function toggleAbbr(){
    showAbbr = !showAbbr;
    // if states are revealed, keep them shown regardless
    gAbbrs.attr('display', (showAbbr || statesRevealed) ? null : 'none');
    btnToggleAbbr.textContent = showAbbr ? 'Hide state abbreviations' : 'Show state abbreviations';
  }

  function attachListListeners(){
    listEl.addEventListener('input', checkAnswers);
    listEl.addEventListener('keyup', e => { if(e.key === 'Enter') checkAnswers(); });
  }

  // Fetch map data (same base map approach as your original exercise)
  fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json')
    .then(r => r.json())
    .then(us => {
      const features = topojson.feature(us, us.objects.states).features
        .filter(f => byFips.has(f.id));

      gStates.selectAll('path')
        .data(features)
        .enter()
        .append('path')
        .attr('id', d => 'state-' + d.id)
        .attr('class','state')
        .attr('d', path);

      // Click a state to focus the corresponding row
      gStates.selectAll('path').on('click', (event, d) => {
        const meta = byFips.get(d.id);
        const idx = order.findIndex(s => s.fips === meta.fips);
        const rows = listEl.querySelectorAll('.row');
        const row = rows[idx];
        if(row){ row.querySelector('.stateInput').focus(); }
      });

      buildList();
      drawNumbers(features);
      drawAbbrs(features);
      drawCaps(features);
      attachListListeners();

      // Buttons
      btnShuffle.addEventListener('click', () => shuffleNumbers(features));
      btnReset.addEventListener('click', resetAll);
      btnToggleNumbers.addEventListener('click', toggleNumbers);
      btnToggleAbbr.addEventListener('click', toggleAbbr);
      btnRevealStates.addEventListener('click', revealStates);
      btnRevealCaps.addEventListener('click', revealCaps);
    });
})();
</script>
</body>
</html>
